# CWE Top 25 Most Dangerous Software Weaknesses 2024
# https://cwe.mitre.org/top25/archive/2024/2024_cwe_top25.html

name: CWE Top 25 2024
version: "1.0.0"
description: Security rules covering CWE Top 25 most dangerous software weaknesses

rules:
  # CWE-787: Out-of-bounds Write (Rank 1)
  - id: CWE-787-001
    name: Potential Buffer Overflow
    severity: Critical
    cwe: ["CWE-787"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - 'strcpy\s*\('
        - 'strcat\s*\('
        - 'sprintf\s*\('
        - 'gets\s*\('
        - 'vsprintf\s*\('
      safe_patterns:
        - 'strncpy'
        - 'strncat'
        - 'snprintf'
        - 'fgets'
    languages: ["c", "cpp"]
    message: Use of unsafe string function that can cause buffer overflow
    remediation: Use bounded string functions (strncpy, snprintf) instead
    enabled: true
    tags: ["memory", "buffer"]

  # CWE-79: XSS (Rank 2) - Covered in OWASP

  # CWE-89: SQL Injection (Rank 3) - Covered in OWASP

  # CWE-416: Use After Free (Rank 4)
  - id: CWE-416-001
    name: Potential Use After Free
    severity: Critical
    cwe: ["CWE-416"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - 'free\s*\([^)]+\)\s*;[^}]*\1'
        - 'delete\s+\w+\s*;[^}]*\1->'
      safe_patterns:
        - '= NULL'
        - '= nullptr'
    languages: ["c", "cpp"]
    message: Potential use-after-free vulnerability
    remediation: Set pointers to NULL after freeing and check before use
    enabled: true
    tags: ["memory"]

  # CWE-78: OS Command Injection (Rank 5) - Covered in OWASP

  # CWE-20: Improper Input Validation (Rank 6)
  - id: CWE-20-001
    name: Missing Input Validation
    severity: Medium
    cwe: ["CWE-20"]
    owasp: ["A03:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'int\([^)]*request\.'
        - 'parseInt\([^)]*req\.'
        - 'float\([^)]*request\.'
        - 'Number\([^)]*req\.'
      safe_patterns:
        - 'try\s*:'
        - 'catch'
        - 'isNaN'
        - 'isFinite'
    languages: ["python", "javascript"]
    message: User input converted without validation
    remediation: Validate and sanitize all user input before processing
    enabled: true
    tags: ["validation"]

  # CWE-125: Out-of-bounds Read (Rank 7)
  - id: CWE-125-001
    name: Potential Out-of-bounds Read
    severity: High
    cwe: ["CWE-125"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - '\[\s*\w+\s*\]\s*//.*user.*input'
        - 'memcpy\([^,]+,[^,]+,\s*\w+\s*\)'
        - 'memmove\([^,]+,[^,]+,\s*\w+\s*\)'
      safe_patterns:
        - 'bounds_check'
        - '\.len\(\)'
        - 'sizeof'
    languages: ["c", "cpp", "rust"]
    message: Potential out-of-bounds read
    remediation: Always validate array indices and buffer sizes before access
    enabled: true
    tags: ["memory"]

  # CWE-22: Path Traversal (Rank 8)
  - id: CWE-22-001
    name: Path Traversal
    severity: High
    cwe: ["CWE-22"]
    owasp: ["A01:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'open\([^)]*request\.'
        - 'readFile\([^)]*req\.'
        - 'os\.path\.join\([^)]*request\.'
        - 'Path\([^)]*request\.'
        - 'fs\.readFile\([^)]*req\.'
      safe_patterns:
        - 'os\.path\.basename'
        - 'secure_filename'
        - 'realpath'
        - 'path\.resolve'
    languages: ["python", "javascript"]
    message: User input used in file path without sanitization
    remediation: Sanitize file paths and use basename, realpath, or whitelist validation
    enabled: true
    tags: ["path", "filesystem"]

  # CWE-352: CSRF (Rank 9)
  - id: CWE-352-001
    name: Missing CSRF Protection
    severity: High
    cwe: ["CWE-352"]
    owasp: ["A01:2021"]
    rule_type:
      type: pattern
      patterns:
        - '@app\.route.*methods.*POST(?!.*csrf)'
        - 'router\.post\([^)]+\)(?!.*csrf)'
      safe_patterns:
        - 'csrf_protect'
        - '@csrf_exempt'
        - 'csurf'
        - 'csrftoken'
    languages: ["python", "javascript"]
    message: POST endpoint may be missing CSRF protection
    remediation: Add CSRF token validation to state-changing endpoints
    enabled: true
    tags: ["csrf", "auth"]

  # CWE-434: Unrestricted File Upload (Rank 10)
  - id: CWE-434-001
    name: Unrestricted File Upload
    severity: High
    cwe: ["CWE-434"]
    owasp: ["A04:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'request\.files\[[^\]]+\]\.save\('
        - 'multer\(\s*\)'
        - 'file\.mv\('
        - 'move_uploaded_file'
      safe_patterns:
        - 'allowed_extensions'
        - 'fileFilter'
        - 'mimetype'
        - 'content-type'
    languages: ["python", "javascript", "php"]
    message: File upload without apparent restriction on file type
    remediation: Validate file type, extension, and content before saving uploaded files
    enabled: true
    tags: ["upload", "filesystem"]

  # CWE-862: Missing Authorization (Rank 11) - Similar to OWASP A01

  # CWE-476: NULL Pointer Dereference (Rank 12)
  - id: CWE-476-001
    name: Potential NULL Pointer Dereference
    severity: High
    cwe: ["CWE-476"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - '\*\w+\s*=.*malloc.*\n[^}]*\*\w+'
        - 'malloc\([^)]+\)\s*;[^}]*\*'
      safe_patterns:
        - 'if\s*\(\s*\w+\s*==\s*NULL'
        - 'if\s*\(\s*!\s*\w+\s*\)'
        - 'if\s*\(\s*\w+\s*!=\s*NULL'
    languages: ["c", "cpp"]
    message: Potential null pointer dereference
    remediation: Check pointer for NULL before dereferencing
    enabled: true
    tags: ["memory", "null"]

  # CWE-287: Improper Authentication (Rank 13)
  - id: CWE-287-001
    name: Weak Authentication
    severity: High
    cwe: ["CWE-287"]
    owasp: ["A07:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'authenticate.*password.*=='
        - 'if.*password\s*==\s*[''"]\w+'
        - 'strcmp\s*\([^)]*password'
      safe_patterns:
        - 'bcrypt'
        - 'argon2'
        - 'pbkdf2'
        - 'constant_time'
    languages: []
    message: Potentially weak authentication mechanism
    remediation: Use secure password comparison and hashing (bcrypt, argon2)
    enabled: true
    tags: ["auth"]

  # CWE-190: Integer Overflow (Rank 14)
  - id: CWE-190-001
    name: Potential Integer Overflow
    severity: High
    cwe: ["CWE-190"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - 'malloc\s*\([^)]*\*[^)]*\)'
        - 'size\s*\*\s*count'
        - 'length\s*\*\s*sizeof'
      safe_patterns:
        - 'SIZE_MAX'
        - 'checked_mul'
        - 'safe_mul'
    languages: ["c", "cpp"]
    message: Potential integer overflow in size calculation
    remediation: Check for overflow before multiplication or use safe integer functions
    enabled: true
    tags: ["integer", "overflow"]

  # CWE-502: Insecure Deserialization (Rank 15) - Covered in OWASP

  # CWE-77: Command Injection (Rank 16) - Similar to CWE-78

  # CWE-119: Buffer Overflow (Rank 17) - Similar to CWE-787
  - id: CWE-119-001
    name: Memory Copy Overflow
    severity: Critical
    cwe: ["CWE-119"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - 'memcpy\([^,]+,[^,]+,\s*sizeof\s*\([^)]+\)\s*\)'
        - 'memset\([^,]+,[^,]+,\s*sizeof\s*\([^)]+\)\s*\)'
      safe_patterns: []
    languages: ["c", "cpp"]
    message: Potential buffer overflow in memory operation
    remediation: Verify buffer sizes match and use safe memory functions
    enabled: true
    tags: ["memory", "buffer"]

  # CWE-798: Hardcoded Credentials (Rank 18) - Covered in OWASP

  # CWE-918: SSRF (Rank 19) - Covered in OWASP

  # CWE-306: Missing Authentication (Rank 20)
  - id: CWE-306-001
    name: Missing Authentication for Critical Function
    severity: High
    cwe: ["CWE-306"]
    owasp: ["A07:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'admin.*route(?!.*auth)'
        - 'delete.*route(?!.*auth)'
        - 'api.*admin(?!.*middleware)'
      safe_patterns:
        - '@login_required'
        - 'isAuthenticated'
        - 'requireAuth'
    languages: []
    message: Critical function may be missing authentication
    remediation: Add authentication check before critical operations
    enabled: true
    tags: ["auth"]

  # CWE-362: Race Condition (Rank 21)
  - id: CWE-362-001
    name: Potential Race Condition
    severity: Medium
    cwe: ["CWE-362"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - 'if\s*\([^)]*exists.*\n.*open'
        - 'os\.path\.exists.*\n.*open'
        - 'access\([^)]+\)\s*&&\s*open'
      safe_patterns:
        - 'lock'
        - 'mutex'
        - 'atomic'
        - 'O_EXCL'
    languages: ["c", "cpp", "python"]
    message: Potential time-of-check time-of-use race condition
    remediation: Use atomic operations or proper locking mechanisms
    enabled: true
    tags: ["concurrency", "race"]

  # CWE-269: Improper Privilege Management (Rank 22)
  - id: CWE-269-001
    name: Excessive Privileges
    severity: Medium
    cwe: ["CWE-269"]
    owasp: ["A01:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'chmod\s*\([^)]*0777'
        - 'chmod\s*777'
        - 'setuid\s*\(\s*0\s*\)'
        - 'sudo\s+-i'
      safe_patterns: []
    languages: []
    message: Potentially excessive file or process privileges
    remediation: Apply principle of least privilege
    enabled: true
    tags: ["privileges"]

  # CWE-94: Code Injection (Rank 23)
  - id: CWE-94-001
    name: Code Injection
    severity: Critical
    cwe: ["CWE-94"]
    owasp: ["A03:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'eval\s*\([^)]*request'
        - 'exec\s*\([^)]*input'
        - 'compile\s*\([^)]*user'
        - 'Function\s*\([^)]*req\.'
      safe_patterns: []
    languages: ["python", "javascript"]
    message: Potential code injection vulnerability
    remediation: Never execute user-controlled input as code
    enabled: true
    tags: ["injection", "code"]

  # CWE-863: Incorrect Authorization (Rank 24) - Similar to CWE-862

  # CWE-276: Incorrect Default Permissions (Rank 25)
  - id: CWE-276-001
    name: Insecure Default Permissions
    severity: Medium
    cwe: ["CWE-276"]
    owasp: ["A01:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'umask\s*\(\s*0\s*\)'
        - 'mode\s*=\s*0o777'
        - 'mode\s*=\s*0777'
        - 'os\.chmod.*0o666'
      safe_patterns: []
    languages: ["python", "c", "cpp"]
    message: Insecure default file permissions
    remediation: Use restrictive default permissions (e.g., 0600 or 0644)
    enabled: true
    tags: ["permissions", "filesystem"]

  # Rust-specific security rules

  # Rust: Unsafe code blocks
  - id: RUST-001
    name: Unsafe Block Usage
    severity: Medium
    cwe: ["CWE-119", "CWE-787"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - 'unsafe\s*\{'
        - 'unsafe\s+fn\s+'
        - 'unsafe\s+impl\s+'
      safe_patterns:
        - '// SAFETY:'
        - '# Safety'
        - 'SAFETY:'
    languages: ["rust"]
    message: Unsafe code block requires careful review for memory safety
    remediation: Document safety invariants with SAFETY comments and minimize unsafe scope
    enabled: true
    tags: ["memory", "unsafe"]

  # Rust: Unchecked unwrap on potential user input
  - id: RUST-002
    name: Unchecked Unwrap on Fallible Operation
    severity: High
    cwe: ["CWE-252", "CWE-476"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - '\.unwrap\(\)'
        - '\.expect\([^)]*\)'
      safe_patterns:
        - '\.unwrap_or'
        - '\.unwrap_or_else'
        - '\.unwrap_or_default'
        - '\?'
        - 'if let'
        - 'match'
    languages: ["rust"]
    message: Unchecked unwrap may panic on error
    remediation: Use ? operator, unwrap_or, or proper error handling instead of unwrap
    enabled: true
    tags: ["error-handling"]

  # Rust: Raw pointer dereference
  - id: RUST-003
    name: Raw Pointer Dereference
    severity: High
    cwe: ["CWE-119", "CWE-416", "CWE-476"]
    owasp: []
    rule_type:
      type: pattern
      patterns:
        - '\*\s*\w+\s+as\s+\*(?:const|mut)'
        - 'ptr::read\('
        - 'ptr::write\('
        - '\.as_ptr\(\)'
        - '\.as_mut_ptr\(\)'
      safe_patterns:
        - 'NonNull'
        - 'is_null'
        - '\.is_some'
    languages: ["rust"]
    message: Raw pointer operations require manual memory safety verification
    remediation: Prefer safe abstractions (NonNull, references) over raw pointers
    enabled: true
    tags: ["memory", "pointers"]
