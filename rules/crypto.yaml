# Cryptographic Security Rules
# Detects common cryptographic misuse patterns

name: Cryptographic Security
version: "1.0.0"
description: Rules for detecting cryptographic misuse and weak algorithms

rules:
  # Random Number Generation
  - id: CRYPTO-001
    name: Insecure Random Number Generator
    severity: High
    cwe: ["CWE-330", "CWE-338"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'random\.random\(\)'
        - 'random\.randint\('
        - 'Math\.random\(\)'
        - 'rand\(\)'
        - 'srand\('
        - 'Random\(\)'
        - 'new Random\('
      safe_patterns:
        - 'secrets\.'
        - 'crypto\.randomBytes'
        - 'SecureRandom'
        - 'SystemRandom'
        - 'urandom'
        - 'getrandom'
    languages: ["python", "javascript", "c", "java"]
    message: Use of non-cryptographic random number generator for security purposes
    remediation: Use cryptographically secure RNG like secrets (Python), crypto.randomBytes (Node), or /dev/urandom
    enabled: true
    tags: ["crypto", "random"]

  # Hardcoded IV/Salt
  - id: CRYPTO-002
    name: Hardcoded IV or Salt
    severity: High
    cwe: ["CWE-329"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - '(?i)iv\s*=\s*[''"][0-9a-f]+[''"]'
        - '(?i)salt\s*=\s*[''"][^''"]+[''"]'
        - '(?i)nonce\s*=\s*[''"][0-9a-f]+[''"]'
        - '(?i)initialization_vector\s*='
      safe_patterns:
        - 'os\.urandom'
        - 'crypto\.randomBytes'
        - 'SecureRandom'
    languages: []
    message: Hardcoded initialization vector or salt detected
    remediation: Generate unique random IV/salt for each encryption operation
    enabled: true
    tags: ["crypto"]

  # Weak Key Derivation
  - id: CRYPTO-003
    name: Weak Key Derivation
    severity: High
    cwe: ["CWE-916"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'hashlib\.(md5|sha1)\([^)]*\.encode'
        - 'crypto\.createHash\([''"]md5'
        - 'crypto\.createHash\([''"]sha1'
        - 'MessageDigest\.getInstance\([''"]MD5'
        - 'MessageDigest\.getInstance\([''"]SHA-1'
      safe_patterns:
        - 'pbkdf2'
        - 'bcrypt'
        - 'argon2'
        - 'scrypt'
        - 'HKDF'
    languages: ["python", "javascript", "java"]
    message: Using weak hash for key derivation
    remediation: Use PBKDF2, bcrypt, scrypt, or Argon2 for password/key derivation
    enabled: true
    tags: ["crypto", "password"]

  # Weak Encryption Algorithms
  - id: CRYPTO-004
    name: Weak Encryption Algorithm - DES
    severity: Critical
    cwe: ["CWE-327"]
    owasp: ["A02:2021"]
    rule_type:
      type: crypto
      weak_algorithms: ["DES", "3DES", "TripleDES", "DESede"]
      insecure_modes: []
      min_key_size: null
    languages: []
    message: Use of weak/deprecated DES encryption
    remediation: Replace DES/3DES with AES-256 or ChaCha20
    enabled: true
    tags: ["crypto", "encryption"]

  - id: CRYPTO-005
    name: Weak Encryption Algorithm - RC4
    severity: Critical
    cwe: ["CWE-327"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - '(?i)\bRC4\b'
        - '(?i)\bARC4\b'
        - '(?i)\bARCFOUR\b'
      safe_patterns: []
    languages: []
    message: Use of weak RC4 stream cipher
    remediation: Replace RC4 with AES-GCM or ChaCha20-Poly1305
    enabled: true
    tags: ["crypto", "encryption"]

  # Insecure Mode of Operation
  - id: CRYPTO-006
    name: ECB Mode Usage
    severity: High
    cwe: ["CWE-327"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - '(?i)MODE_ECB'
        - '(?i)AES/ECB'
        - '(?i)DES/ECB'
        - '(?i)\.ECB\b'
        - 'MCRYPT_MODE_ECB'
      safe_patterns: []
    languages: []
    message: Use of insecure ECB mode for block cipher
    remediation: Use authenticated encryption modes like GCM, CCM, or CBC with HMAC
    enabled: true
    tags: ["crypto", "encryption"]

  # Insufficient Key Size
  - id: CRYPTO-007
    name: Insufficient AES Key Size
    severity: Medium
    cwe: ["CWE-326"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'AES-128'
        - 'AES128'
        - 'keysize\s*=\s*16'
        - 'key_size\s*=\s*16'
      safe_patterns: []
    languages: []
    message: AES-128 used - consider AES-256 for higher security
    remediation: Use AES-256 for maximum security margin
    enabled: true
    tags: ["crypto", "encryption"]

  - id: CRYPTO-008
    name: Weak RSA Key Size
    severity: High
    cwe: ["CWE-326"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'RSA\s*\(\s*1024'
        - 'key_size\s*=\s*1024'
        - 'generate\s*\(\s*1024'
        - 'bits\s*=\s*1024'
      safe_patterns: []
    languages: []
    message: RSA key size too small (1024 bits)
    remediation: Use RSA with at least 2048 bits, preferably 4096 bits
    enabled: true
    tags: ["crypto", "asymmetric"]

  # Hash Function Usage
  - id: CRYPTO-009
    name: MD5 Usage
    severity: High
    cwe: ["CWE-327", "CWE-328"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - '(?i)\bmd5\s*\('
        - '(?i)hashlib\.md5'
        - '(?i)crypto\.createHash\([''"]md5'
        - '(?i)MessageDigest.*MD5'
        - '(?i)Digest::MD5'
      safe_patterns: []
    languages: []
    message: Use of MD5 hash function
    remediation: Use SHA-256 or SHA-3 for hashing, PBKDF2/bcrypt for passwords
    enabled: true
    tags: ["crypto", "hash"]

  - id: CRYPTO-010
    name: SHA1 Usage
    severity: Medium
    cwe: ["CWE-327", "CWE-328"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - '(?i)\bsha1\s*\('
        - '(?i)hashlib\.sha1'
        - '(?i)crypto\.createHash\([''"]sha1'
        - '(?i)MessageDigest.*SHA-1'
        - '(?i)Digest::SHA1'
      safe_patterns:
        - 'git'
        - 'hmac'
    languages: []
    message: Use of SHA-1 hash function (deprecated for security)
    remediation: Use SHA-256 or SHA-3 for security-sensitive operations
    enabled: true
    tags: ["crypto", "hash"]

  # SSL/TLS Issues
  - id: CRYPTO-011
    name: SSL/TLS Certificate Verification Disabled
    severity: Critical
    cwe: ["CWE-295"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'verify\s*=\s*False'
        - 'CERT_NONE'
        - 'rejectUnauthorized\s*:\s*false'
        - 'InsecureRequestWarning'
        - 'ssl_verify.*false'
        - 'check_hostname\s*=\s*False'
      safe_patterns: []
    languages: []
    message: SSL/TLS certificate verification disabled
    remediation: Always verify certificates in production; use proper CA bundles
    enabled: true
    tags: ["crypto", "ssl", "tls"]

  - id: CRYPTO-012
    name: Deprecated SSL/TLS Version
    severity: High
    cwe: ["CWE-327"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'SSLv2'
        - 'SSLv3'
        - 'TLSv1\.0'
        - 'TLSv1_0'
        - 'TLS1_0'
        - 'PROTOCOL_SSLv'
        - 'TLS_1_0'
      safe_patterns: []
    languages: []
    message: Use of deprecated SSL/TLS version
    remediation: Use TLS 1.2 or TLS 1.3 only
    enabled: true
    tags: ["crypto", "ssl", "tls"]

  # Padding Issues
  - id: CRYPTO-013
    name: PKCS1 v1.5 Padding
    severity: Medium
    cwe: ["CWE-780"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'PKCS1v15'
        - 'PKCS1_v1_5'
        - 'RSA_PKCS1_PADDING'
        - 'RSAES-PKCS1-v1_5'
      safe_patterns:
        - 'PSS'
        - 'OAEP'
    languages: []
    message: Use of vulnerable PKCS#1 v1.5 padding
    remediation: Use RSA-OAEP for encryption or RSA-PSS for signatures
    enabled: true
    tags: ["crypto", "padding"]

  # Timing Attacks
  - id: CRYPTO-014
    name: Non-Constant-Time Comparison
    severity: High
    cwe: ["CWE-208"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'password\s*==\s*'
        - 'secret\s*==\s*'
        - 'token\s*==\s*'
        - 'hmac\s*==\s*'
        - 'signature\s*==\s*'
        - 'mac\s*==\s*'
      safe_patterns:
        - 'hmac\.compare_digest'
        - 'constant_time'
        - 'crypto\.timingSafeEqual'
        - 'secure_compare'
    languages: []
    message: Potentially timing-vulnerable comparison of secrets
    remediation: Use constant-time comparison functions for secrets
    enabled: true
    tags: ["crypto", "timing"]
