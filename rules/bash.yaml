# Bash/Shell Script Security Rules
# Covers common shell scripting vulnerabilities

name: Bash Security Rules
version: "1.0.0"
description: Security rules for Bash, sh, and zsh shell scripts

rules:
  # Command Injection via Unquoted Variables
  - id: BASH-001
    name: Unquoted Variable in Command
    severity: Critical
    cwe: ["CWE-78"]
    owasp: ["A03:2021"]
    rule_type:
      type: pattern
      patterns:
        # Unquoted variables in command context
        - '\$[a-zA-Z_][a-zA-Z0-9_]*\s*[|;&]'
        - 'eval\s+\$[a-zA-Z_]'
        - 'eval\s+"[^"]*\$[a-zA-Z_][a-zA-Z0-9_]*[^"]*"'
        - '`[^`]*\$[a-zA-Z_][a-zA-Z0-9_]*[^`]*`'
        # Dangerous command substitution
        - '\$\(\s*\$[a-zA-Z_]'
      safe_patterns:
        - '"${[a-zA-Z_][a-zA-Z0-9_]*}"'
        - '"$[a-zA-Z_][a-zA-Z0-9_]*"'
    languages: ["bash"]
    message: Unquoted variable may allow command injection
    remediation: Always quote variables in shell scripts using "$var" or "${var}"
    enabled: true
    tags: ["injection", "command"]

  # Insecure Temporary File Creation
  - id: BASH-002
    name: Insecure Temp File Creation
    severity: High
    cwe: ["CWE-377", "CWE-379"]
    owasp: ["A05:2021"]
    rule_type:
      type: pattern
      patterns:
        # Predictable temp file names
        - '/tmp/[a-zA-Z0-9_-]+\.'
        - '>/tmp/\$\$'
        - 'TMPFILE=/tmp/'
        - 'tempfile=/tmp/'
        # Not using mktemp
        - 'touch\s+/tmp/[^$]'
      safe_patterns:
        - 'mktemp'
        - 'TMPDIR'
        - '/tmp/\$\(mktemp'
    languages: ["bash"]
    message: Insecure temporary file creation may allow symlink attacks
    remediation: Use mktemp to create temporary files securely
    enabled: true
    tags: ["tempfile", "race-condition"]

  # Curl Without Certificate Verification
  - id: BASH-003
    name: Curl Insecure TLS
    severity: High
    cwe: ["CWE-295"]
    owasp: ["A02:2021"]
    rule_type:
      type: pattern
      patterns:
        - 'curl\s+.*-k\s'
        - 'curl\s+.*--insecure'
        - 'wget\s+.*--no-check-certificate'
      safe_patterns: []
    languages: ["bash"]
    message: TLS certificate verification disabled
    remediation: Remove -k/--insecure flag and ensure proper CA certificates are installed
    enabled: true
    tags: ["crypto", "tls"]

  # Dangerous File Permissions
  - id: BASH-004
    name: World Writable Permissions
    severity: High
    cwe: ["CWE-732"]
    owasp: ["A01:2021"]
    rule_type:
      type: pattern
      patterns:
        # chmod 777, 666, or o+w
        - 'chmod\s+777\s'
        - 'chmod\s+666\s'
        - 'chmod\s+.*o\+w'
        - 'chmod\s+-R\s+777'
        # Umask too permissive
        - 'umask\s+0*0[0-3][0-7]'
      safe_patterns:
        - 'chmod\s+700'
        - 'chmod\s+600'
        - 'chmod\s+755'
        - 'chmod\s+644'
    languages: ["bash"]
    message: World-writable permissions may allow unauthorized access
    remediation: Use restrictive permissions (700/600 for sensitive files)
    enabled: true
    tags: ["permissions", "access-control"]

  # Eval of External Input
  - id: BASH-005
    name: Dangerous Eval Usage
    severity: Critical
    cwe: ["CWE-94", "CWE-95"]
    owasp: ["A03:2021"]
    rule_type:
      type: pattern
      patterns:
        # eval with external/user input
        - 'eval\s+"\$[^"]*"'
        - 'eval\s+\$\{'
        - 'eval\s+`'
        - 'eval\s+\$\('
        # Sourcing untrusted files
        - 'source\s+\$[a-zA-Z_]'
        - '\.\s+\$[a-zA-Z_]'
      safe_patterns:
        - 'eval\s+"set\s'
        - 'eval\s+"export\s'
    languages: ["bash"]
    message: Eval with variable input may allow code injection
    remediation: Avoid eval with user input; use safer alternatives like arrays
    enabled: true
    tags: ["injection", "eval"]
